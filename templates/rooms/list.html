{% extends 'base.html' %}

{% block title %}Habitaciones - Hotel O11CE{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% if hotel %}{% url 'panel_dashboard_hotel' hotel.slug %}{% else %}{% url 'dashboard' %}{% endif %}">
                <i class="fas fa-hotel"></i> O11CE
            </a>
            
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle"></i> {{ user.get_full_name|default:user.username }}
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'profile' %}">
                            <i class="fas fa-user"></i> Perfil
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'settings' %}">
                            <i class="fas fa-cog"></i> Configuración
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{% url 'logout' %}">
                            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2">
                <div class="sidebar">
                    <a href="{% if hotel %}{% url 'panel_dashboard_hotel' hotel.slug %}{% else %}{% url 'dashboard' %}{% endif %}" class="sidebar-item">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                    <a href="{% if hotel %}{% url 'panel_rooms_hotel' hotel.slug %}{% else %}{% url 'rooms' %}{% endif %}" class="sidebar-item active">
                        <i class="fas fa-bed"></i> Habitaciones
                    </a>
                    <a href="{% if hotel %}{% url 'panel_bookings_hotel' hotel.slug %}{% else %}{% url 'bookings' %}{% endif %}" class="sidebar-item">
                        <i class="fas fa-calendar-check"></i> Reservas
                    </a>
                    <a href="{% if hotel %}{% url 'panel_clients_hotel' hotel.slug %}{% else %}{% url 'clients' %}{% endif %}" class="sidebar-item">
                        <i class="fas fa-users"></i> Clientes
                    </a>
                    <a href="{% url 'cleaning' %}" class="sidebar-item">
                        <i class="fas fa-broom"></i> Limpieza
                    </a>
                    <a href="{% url 'maintenance' %}" class="sidebar-item">
                        <i class="fas fa-tools"></i> Mantenimiento
                    </a>
                    <a href="{% url 'administration' %}" class="sidebar-item">
                        <i class="fas fa-cogs"></i> Administración
                    </a>
                    <a href="{% url 'reports' %}" class="sidebar-item">
                        <i class="fas fa-chart-bar"></i> Reportes
                    </a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10">
                <div class="main-content">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1 class="h3 mb-0">Gestión de Habitaciones</h1>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRoomModal">
                            <i class="fas fa-plus"></i> Nueva Habitación
                        </button>
                    </div>

                    <!-- Filters -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label">Estado</label>
                                    <select class="form-select" id="statusFilter">
                                        <option value="">Todos</option>
                                        <option value="available">Disponible</option>
                                        <option value="occupied">Ocupada</option>
                                        <option value="cleaning">En Limpieza</option>
                                        <option value="maintenance">En Mantenimiento</option>
                                        <option value="reserved">Reservada</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Tipo</label>
                                    <select class="form-select" id="typeFilter">
                                        <option value="">Todos</option>
                                        <option value="individual">Individual</option>
                                        <option value="double">Doble</option>
                                        <option value="triple">Triple</option>
                                        <option value="suite">Suite</option>
                                        <option value="family">Familiar</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Piso</label>
                                    <select class="form-select" id="floorFilter">
                                        <option value="">Todos</option>
                                        <option value="1">Piso 1</option>
                                        <option value="2">Piso 2</option>
                                        <option value="3">Piso 3</option>
                                        <option value="4">Piso 4</option>
                                        <option value="5">Piso 5</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Buscar</label>
                                    <input type="text" class="form-control" id="searchInput" placeholder="Número de habitación...">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rooms Grid -->
                    <div class="row" id="roomsGrid">
                        {% for room in rooms %}
                        <div class="col-md-4 col-lg-3 mb-4 room-card" 
                             data-id="{{ room.id }}"
                             data-status="{{ room.status }}" 
                             data-type="{{ room.type }}" 
                             data-floor="{{ room.floor }}"
                             data-number="{{ room.number }}"
                             data-capacity="{{ room.capacity }}"
                             data-price="{{ room.price }}"
                             data-description="{{ room.description|default:''|escape }}">
                            <div class="card h-100">
                                <div class="card-header text-center py-3">
                                    <h5 class="mb-0">
                                        <i class="fas fa-bed"></i> Habitación {{ room.number }}
                                    </h5>
                                    <small class="text-muted">Piso {{ room.floor }}</small>
                                </div>
                                <div class="card-body">
                                    <div class="text-center mb-3">
                                        <span class="badge bg-{% if room.status == 'available' %}success{% elif room.status == 'occupied' %}danger{% elif room.status == 'cleaning' %}info{% elif room.status == 'maintenance' %}warning{% else %}secondary{% endif %} fs-6">
                                            {{ room.get_status_display }}
                                        </span>
                                    </div>
                                    
                                    <div class="row text-center mb-3">
                                        <div class="col-6">
                                            <small class="text-muted">Tipo</small>
                                            <div class="fw-bold">{{ room.get_type_display }}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Capacidad</small>
                                            <div class="fw-bold">{{ room.capacity }} personas</div>
                                        </div>
                                    </div>
                                    
                                    <div class="text-center mb-3">
                                        <small class="text-muted">Precio por noche</small>
                                        <div class="fw-bold text-primary">${{ room.price }}</div>
                                    </div>
                                    
                                    {% if room.description %}
                                    <div class="mb-3">
                                        <small class="text-muted">Descripción</small>
                                        <div class="small">{{ room.description|truncatewords:10 }}</div>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer">
                                    <div class="btn-group w-100" role="group">
                                        <button class="btn btn-outline-primary btn-sm" onclick="editRoom({{ room.id }})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-info btn-sm" onclick="viewRoom({{ room.id }})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if room.active %}
                                        <button class="btn btn-outline-danger btn-sm" onclick="toggleRoom({{ room.id }}, false)">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        {% else %}
                                        <button class="btn btn-outline-success btn-sm" onclick="toggleRoom({{ room.id }}, true)">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <div class="text-center py-5">
                                <i class="fas fa-bed fa-3x text-muted mb-3"></i>
                                <h4 class="text-muted">No hay habitaciones registradas</h4>
                                <p class="text-muted">Comienza agregando la primera habitación</p>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRoomModal">
                                    <i class="fas fa-plus"></i> Agregar Habitación
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Room Modal -->
<div class="modal fade" id="addRoomModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nueva Habitación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addRoomForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Número de Habitación</label>
                                <input type="text" class="form-control" name="number" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Piso</label>
                                <input type="number" class="form-control" name="floor" min="1" value="1" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Tipo</label>
                                <select class="form-select" name="type" required>
                                    <option value="individual">Individual</option>
                                    <option value="double">Doble</option>
                                    <option value="triple">Triple</option>
                                    <option value="suite">Suite</option>
                                    <option value="family">Familiar</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Capacidad</label>
                                <input type="number" class="form-control" name="capacity" min="1" value="1" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Precio por Noche</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" name="price" min="0" step="0.01" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Habitación</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Room Detail Modal (inline, sin redirección) -->
<div class="modal fade" id="roomDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalle de Habitación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="roomDetailLoading" class="text-center py-4">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="text-muted mt-2 mb-0">Cargando detalle...</p>
        </div>
        <div id="roomDetailContent" class="d-none">
          <div class="row g-4">
            <div class="col-lg-7">
              <div class="card mb-3">
                <div class="card-body">
                  <div id="roomMainImage" class="mb-3 text-center"></div>
                  <div id="roomThumbs" class="d-flex flex-wrap gap-2"></div>
                </div>
              </div>
              <div class="card">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div id="calendarMonth" class="fw-bold"></div>
                    <div class="btn-group">
                      <button class="btn btn-outline-primary btn-sm" id="calPrevBtn"><i class="fas fa-chevron-left"></i></button>
                      <button class="btn btn-outline-primary btn-sm" id="calNextBtn"><i class="fas fa-chevron-right"></i></button>
                    </div>
                  </div>
                  <div id="calendarGrid" class="d-grid" style="grid-template-columns:repeat(7,1fr);gap:4px;"></div>
                </div>
              </div>
            </div>
            <div class="col-lg-5">
              <div class="card">
                <div class="card-body">
                  <h4 class="fw-bold" id="roomTitle"></h4>
                  <div class="mb-3">
                    <label class="form-label">Estado</label>
                    <select class="form-select" id="detailStatusSelect">
                      <option value="available">Disponible</option>
                      <option value="occupied">Ocupada</option>
                      <option value="cleaning">En Limpieza</option>
                      <option value="maintenance">En Mantenimiento</option>
                      <option value="reserved">Reservada</option>
                    </select>
                  </div>
                  <form id="roomDetailEditForm">
                    <div class="mb-2">
                      <label class="form-label">Número</label>
                      <input type="text" class="form-control" id="detailNumber">
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Tipo</label>
                      <select class="form-select" id="detailType">
                        <option value="individual">Individual</option>
                        <option value="double">Doble</option>
                        <option value="triple">Triple</option>
                        <option value="suite">Suite</option>
                        <option value="family">Familiar</option>
                      </select>
                    </div>
                    <div class="row g-2 mb-2">
                      <div class="col-6">
                        <label class="form-label">Capacidad</label>
                        <input type="number" class="form-control" id="detailCapacity" min="1">
                      </div>
                      <div class="col-6">
                        <label class="form-label">Piso</label>
                        <input type="number" class="form-control" id="detailFloor" min="1">
                      </div>
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Precio por noche</label>
                      <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="detailPrice" min="0" step="0.01">
                      </div>
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Descripción</label>
                      <textarea class="form-control" id="detailDescription" rows="3"></textarea>
                    </div>
                    <div class="form-check mb-3">
                      <input class="form-check-input" type="checkbox" id="detailActive">
                      <label class="form-check-label" for="detailActive">Habitación activa</label>
                    </div>
                    <div class="d-flex gap-2">
                      <button type="button" class="btn btn-primary" id="detailSaveBtn"><i class="fas fa-save me-1"></i>Guardar cambios</button>
                      <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

<script>
// Filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const statusFilter = document.getElementById('statusFilter');
    const typeFilter = document.getElementById('typeFilter');
    const floorFilter = document.getElementById('floorFilter');
    const searchInput = document.getElementById('searchInput');
    
    function filterRooms() {
        const status = statusFilter.value;
        const type = typeFilter.value;
        const floor = floorFilter.value;
        const search = searchInput.value.toLowerCase();
        
        const rooms = document.querySelectorAll('.room-card');
        
        rooms.forEach(room => {
            const roomStatus = room.dataset.status;
            const roomType = room.dataset.type;
            const roomFloor = room.dataset.floor;
            const roomNumber = room.dataset.number;
            
            const statusMatch = !status || roomStatus === status;
            const typeMatch = !type || roomType === type;
            const floorMatch = !floor || roomFloor === floor;
            const searchMatch = !search || roomNumber.includes(search);
            
            if (statusMatch && typeMatch && floorMatch && searchMatch) {
                room.style.display = 'block';
            } else {
                room.style.display = 'none';
            }
        });
    }
    
    statusFilter.addEventListener('change', filterRooms);
    typeFilter.addEventListener('change', filterRooms);
    floorFilter.addEventListener('change', filterRooms);
    searchInput.addEventListener('input', filterRooms);
});

// Helpers
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const HOTEL_SLUG = '{{ hotel.slug|default:"" }}';

function findRoomCard(roomId) {
    return document.querySelector(`.room-card[data-id="${roomId}"]`);
}

function openEditModalWith(roomId) {
    const card = findRoomCard(roomId);
    if (!card) return;
    const form = document.getElementById('addRoomForm');
    form.dataset.mode = 'edit';
    form.dataset.roomId = String(roomId);
    // Prefill
    form.querySelector('input[name="number"]').value = card.dataset.number || '';
    form.querySelector('input[name="floor"]').value = card.dataset.floor || '';
    form.querySelector('select[name="type"]').value = card.dataset.type || '';
    form.querySelector('input[name="capacity"]').value = card.dataset.capacity || '1';
    form.querySelector('input[name="price"]').value = card.dataset.price || '';
    form.querySelector('textarea[name="description"]').value = card.dataset.description || '';
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('addRoomModal'));
    modal.show();
}

// Room management functions
function editRoom(roomId) {
    openEditModalWith(roomId);
}

function viewRoom(roomId) {
    const modal = new bootstrap.Modal(document.getElementById('roomDetailModal'));
    document.getElementById('roomDetailLoading').classList.remove('d-none');
    document.getElementById('roomDetailContent').classList.add('d-none');
    modal.show();
    fetch(`/api/rooms/${roomId}/detail/`).then(async res => {
        if (!res.ok) { throw new Error('Error al cargar detalle'); }
        const data = await res.json();
        document.getElementById('roomTitle').textContent = `Hab. ${data.number} · ${data.type_label}`;
        const main = (data.images || []).find(i => i.is_main) || (data.images || [])[0];
        const mainEl = document.getElementById('roomMainImage');
        mainEl.innerHTML = main && main.url ? `<img src="${main.url}" class="img-fluid rounded" alt="${main.alt||''}">` : '<div class="text-muted">Sin imagen</div>';
        const thumbsEl = document.getElementById('roomThumbs');
        thumbsEl.innerHTML = '';
        (data.images || []).forEach(img => {
            if (!img.url) return;
            const a = document.createElement('a');
            a.href = '#';
            a.onclick = (e)=>{ e.preventDefault(); mainEl.innerHTML = `<img src='${img.url}' class='img-fluid rounded' alt='${img.alt||''}'>`; };
            a.innerHTML = `<img src="${img.url}" class="rounded" style="width:72px;height:72px;object-fit:cover;" alt="${img.alt||''}">`;
            thumbsEl.appendChild(a);
        });
        document.getElementById('detailStatusSelect').value = data.status;
        document.getElementById('detailNumber').value = data.number;
        document.getElementById('detailType').value = data.type;
        document.getElementById('detailCapacity').value = data.capacity;
        document.getElementById('detailFloor').value = data.floor;
        document.getElementById('detailPrice').value = data.price;
        document.getElementById('detailDescription').value = data.description || '';
        document.getElementById('detailActive').checked = !!data.active;
        document.getElementById('detailStatusSelect').onchange = async function(){
          const next = this.value;
          const res = await fetch(`/api/rooms/${roomId}/`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ status: next })
          });
          if (!res.ok) { const err = await res.json().catch(()=>({})); alert('Error al cambiar estado: ' + (err.error||res.statusText)); this.value = data.status; return; }
        };
        document.getElementById('detailSaveBtn').onclick = async function(){
          const payload = {
            number: document.getElementById('detailNumber').value,
            type: document.getElementById('detailType').value,
            capacity: parseInt(document.getElementById('detailCapacity').value||'1'),
            floor: parseInt(document.getElementById('detailFloor').value||'1'),
            price: parseFloat(document.getElementById('detailPrice').value||'0'),
            description: document.getElementById('detailDescription').value||'',
            active: document.getElementById('detailActive').checked,
            status: document.getElementById('detailStatusSelect').value
          };
          const res = await fetch(`/api/rooms/${roomId}/`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify(payload)
          });
          if (res.ok) { location.reload(); } else { const err = await res.json().catch(()=>({})); alert('Error al guardar: ' + (err.error||res.statusText)); }
        };
        initAdminCalendar(roomId);
        document.getElementById('roomDetailLoading').classList.add('d-none');
        document.getElementById('roomDetailContent').classList.remove('d-none');
    }).catch(()=>{
        document.getElementById('roomDetailLoading').innerHTML = '<div class="text-danger">No se pudo cargar el detalle</div>';
    });
}

let calCurrent = new Date();
function initAdminCalendar(roomId){
  const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const monthEl = document.getElementById('calendarMonth');
  const gridEl = document.getElementById('calendarGrid');
  document.getElementById('calPrevBtn').onclick = ()=>{ calCurrent.setMonth(calCurrent.getMonth()-1); renderCalendar(roomId); };
  document.getElementById('calNextBtn').onclick = ()=>{ calCurrent.setMonth(calCurrent.getMonth()+1); renderCalendar(roomId); };
  function renderHeaders(){
    gridEl.innerHTML='';
    ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'].forEach(d=>{ const h=document.createElement('div'); h.className='text-center fw-bold bg-light p-1'; h.textContent=d; gridEl.appendChild(h); });
  }
  async function renderCalendar(roomId){
    monthEl.textContent = `${monthNames[calCurrent.getMonth()]} ${calCurrent.getFullYear()}`;
    renderHeaders();
    const start = new Date(calCurrent.getFullYear(), calCurrent.getMonth(), 1);
    const end = new Date(calCurrent.getFullYear(), calCurrent.getMonth()+1, 0);
    const padStart = new Date(start); padStart.setDate(padStart.getDate()-padStart.getDay());
    const iso = d=> new Date(d).toISOString().split('T')[0];
    let avail = {};
    try {
      const r = await fetch(`/portal/room-availability/${roomId}/?start_date=${iso(padStart)}&end_date=${iso(end)}`);
      const j = await r.json(); avail = j.availability||{};
    } catch(e) {}
    for(let i=0;i<42;i++){
      const date = new Date(padStart); date.setDate(padStart.getDate()+i);
      const cell = document.createElement('div');
      cell.className = 'text-center border rounded p-2';
      if(date.getMonth()!==calCurrent.getMonth()) cell.classList.add('bg-light');
      const ds = iso(date);
      const a = avail[ds];
      if(a && a.available){ cell.classList.add('bg-success','bg-opacity-10'); }
      if(a && !a.available){ cell.classList.add('bg-danger','bg-opacity-10'); cell.style.opacity='0.7'; }
      cell.textContent = String(date.getDate());
      gridEl.appendChild(cell);
    }
  }
  renderCalendar(roomId);
}


function toggleRoom(roomId, active) {
    fetch(`/api/rooms/${roomId}/`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ active: !!active })
    }).then(async res => {
        if (res.ok) {
            location.reload();
        } else {
            const err = await res.json().catch(() => ({}));
            alert('Error al actualizar: ' + (err.error || res.statusText));
        }
    }).catch(() => alert('Error de red'));
}

// Interceptar submit para crear/editar
document.getElementById('addRoomForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = e.currentTarget;
    const payload = {
        number: form.number.value,
        floor: parseInt(form.floor.value || '1'),
        type: form.type.value,
        capacity: parseInt(form.capacity.value || '1'),
        price: parseFloat(form.price.value || '0'),
        description: form.description.value || ''
    };
    const isEdit = form.dataset.mode === 'edit';
    const roomId = form.dataset.roomId;
    const baseUrl = isEdit ? `/api/rooms/${roomId}/` : '/api/rooms/';
    const url = (!isEdit && HOTEL_SLUG) ? `${baseUrl}?hotel=${encodeURIComponent(HOTEL_SLUG)}` : baseUrl;
    fetch(url, {
        method: isEdit ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify(payload)
    }).then(async res => {
        if (res.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addRoomModal')).hide();
            location.reload();
        } else {
            const err = await res.json().catch(() => ({}));
            alert('Error al guardar: ' + (err.error || res.statusText));
        }
    }).catch(() => alert('Error de red'));
});
</script>
{% endblock %}
